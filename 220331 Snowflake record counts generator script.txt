USE ROLE TIMWILSONDV; 

USE DATABASE VAULT_FIVETRAN;

-- Generate a SELECT script to determine record counts
-- for tables being replicated by Fivetran

SELECT LISTAGG(SELECTION, ' UNION ALL ') || ';'
FROM (
    SELECT 'SELECT \'' || OBJECT_NAME || '\' OBJECT_NAME, COUNT(*) RECORD_COUNT FROM ' || OBJECT_NAME AS SELECTION
    FROM (
        SELECT TABLE_CATALOG ||'.'|| TABLE_SCHEMA ||'."'|| TABLE_NAME ||'"' OBJECT_NAME
        FROM  VAULT_FIVETRAN.INFORMATION_SCHEMA.TABLES
        WHERE TABLE_SCHEMA NOT IN ('INFORMATION_SCHEMA', 'PUBLIC', 'TESTSCHEMA', 'FIVETRAN_RELIEF_UNSUBTLE_STAGING')
        AND TABLE_NAME NOT LIKE 'FIVETRAN%'
        UNION ALL
        SELECT TABLE_CATALOG ||'.'|| TABLE_SCHEMA ||'."'|| TABLE_NAME ||'"' OBJECT_NAME
        FROM  VAULT_FIVETRAN.INFORMATION_SCHEMA.VIEWS
        WHERE TABLE_SCHEMA NOT IN ('INFORMATION_SCHEMA', 'PUBLIC', 'TESTSCHEMA', 'FIVETRAN_RELIEF_UNSUBTLE_STAGING')
        AND TABLE_NAME NOT LIKE 'FIVETRAN%'
    )
)
; 
