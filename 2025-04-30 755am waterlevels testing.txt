-- 211
-- 212
-- 213
-- 214
-- 216
-- 219
-- 220
-- 221
-- 233
SELECT COUNT(*)
FROM TIM_WILSON.TIM_WILSON.WATERLEVELS
;

SELECT *
FROM TIM_WILSON.TIM_WILSON.WATERLEVELS
ORDER BY STARTED_AT_TS DESC, TABLE_NAME ASC
;

-- 27
-- 28
-- 29
-- 30
-- 32
-- 35
-- 36
-- 37
-- 38
SELECT *
FROM TIM_WILSON.TIM_WILSON.WATERLEVELS
WHERE TABLE_NAME ILIKE 'TIM_WILSON.BRONZE.STG_COMPANY'
ORDER BY STARTED_AT_TS DESC, TABLE_NAME ASC
;

SELECT *
FROM TIM_WILSON.BRONZE.STG_COMPANY
;

SELECT

    LABORDTL_COMPANY,
    EXTRACT_DATE,
    TO_TIMESTAMP(EXTRACT_DATE),
    TO_TIMESTAMP('2025-04-28 08:00:08.743127'),
    DATE_PART(EPOCH_MICROSECOND ,TO_TIMESTAMP(EXTRACT_DATE)),
    DATE_PART(EPOCH_MICROSECOND ,TO_TIMESTAMP('2025-04-28 08:00:08.743127')),
    TO_TIMESTAMP(EXTRACT_DATE) > TO_TIMESTAMP('2025-04-28 08:00:08.743127') AS x1,
    DATE_PART(EPOCH_MICROSECOND ,TO_TIMESTAMP(EXTRACT_DATE)) > DATE_PART(EPOCH_MICROSECOND ,TO_TIMESTAMP('2025-04-28 08:00:08.743127')) AS x1a,
    TO_TIMESTAMP(EXTRACT_DATE) < TO_TIMESTAMP('2025-04-28 08:00:08.743127') AS x2,
    TO_TIMESTAMP('2025-04-28 08:00:08.743127') < TO_TIMESTAMP(EXTRACT_DATE) AS x3,
    TO_TIMESTAMP('2025-04-28 08:00:08.743127') > TO_TIMESTAMP(EXTRACT_DATE) AS x4,
    TO_TIMESTAMP('2025-04-28 08:00:08.743') > TO_TIMESTAMP('2025-04-28 08:00:08.743127') AS y1,
    TO_TIMESTAMP('2025-04-28 08:00:08.743127') > TO_TIMESTAMP('2025-04-28 08:00:08.743127') AS y2,
    TO_TIMESTAMP(EXTRACT_DATE) > TO_TIMESTAMP(EXTRACT_DATE) AS z1,
    TO_TIMESTAMP(EXTRACT_DATE) < TO_TIMESTAMP(EXTRACT_DATE) AS z2

    FROM TIM_WILSON.BRONZE.raw_company
    WHERE 1=1
    -- AND TO_TIMESTAMP(EXTRACT_DATE) > TO_TIMESTAMP('2025-04-28 08:00:08.743127')
    -- AND DATE_PART(EPOCH_MICROSECOND ,TO_TIMESTAMP(EXTRACT_DATE)) > DATE_PART(EPOCH_MICROSECOND,TO_TIMESTAMP('2025-04-28 08:00:08.743127'))
    AND TO_TIMESTAMP(EXTRACT_DATE) > (SELECT rnselect.WATERLEVEL_TS
            FROM (SELECT WATERLEVEL_TS
                       , ROW_NUMBER() OVER (PARTITION BY TABLE_NAME ORDER BY WATERLEVEL_TS DESC) AS rn
                  FROM TIM_WILSON.TIM_WILSON.waterlevels
                  WHERE TABLE_NAME = 'BRONZE.stg_company'
                    AND WATERLEVEL_TS IS NOT NULL
            ) rnselect
            WHERE rnselect.rn = 1)
;

-- full refresh load:
-- does not drop the waterlevels table
-- WATERLEVEL_TS assigned max value of the timestamp column used for waterlevel tracking

-- incremental load:
-- if nothing to load
-- does not drop the waterlevels table
-- WATERLEVEL_TS assigned NULL

-- incremental load:
-- if something to load
-- does not drop the waterlevels table
-- WATERLEVEL_TS assigned max value of the timestamp column used for waterlevel tracking



-- Generated by AutomateDV (formerly known as dbtvault)

    
-- depends_on: TIM_WILSON.TIM_WILSON.waterlevels

WITH source_data AS (

    SELECT

    LABORDTL_COMPANY,
    EXTRACT_DATE

    FROM TIM_WILSON.BRONZE.raw_company
    WHERE TO_TIMESTAMP(EXTRACT_DATE) > (SELECT rnselect.WATERLEVEL_TS
                    FROM (SELECT WATERLEVEL_TS
                               , ROW_NUMBER() OVER (PARTITION BY TABLE_NAME ORDER BY WATERLEVEL_TS DESC) AS rn
                          FROM TIM_WILSON.TIM_WILSON.waterlevels
                          WHERE TABLE_NAME = 'TIM_WILSON.BRONZE.stg_company'
                            AND WATERLEVEL_TS IS NOT NULL
                    ) rnselect
                    WHERE rnselect.rn = 1)
),

derived_columns AS (

    SELECT

    LABORDTL_COMPANY,
    EXTRACT_DATE,
    TO_TIMESTAMP('2025-04-30 10:09:40.712510') AS LOAD_DATETIME,
    TO_TIMESTAMP('1900-01-01 00:00:00.000000') AS START_DATE,
    TO_TIMESTAMP('9999-12-31 23:59:59.999999') AS END_DATE,
    TO_TIMESTAMP('1900-01-01 00:00:00.000000') AS EFFECTIVE_FROM,
    'MANUFACTURING.RESGRPEFF' AS RECORD_SOURCE,
    'MANUFACTURING' AS COLLISION_KEY,
    LABORDTL_COMPANY AS COMPANY_ID

    FROM source_data
),

hashed_columns AS (

    SELECT

    LABORDTL_COMPANY,
    EXTRACT_DATE,
    LOAD_DATETIME,
    START_DATE,
    END_DATE,
    EFFECTIVE_FROM,
    RECORD_SOURCE,
    COLLISION_KEY,
    COMPANY_ID,

    CAST(MD5_BINARY(NULLIF(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST(COLLISION_KEY AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST(COMPANY_ID AS VARCHAR))), ''), '^^')
    ), '^^||^^')) AS BINARY(16)) AS COMPANY_HK

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    LABORDTL_COMPANY,
    EXTRACT_DATE,
    LOAD_DATETIME,
    START_DATE,
    END_DATE,
    EFFECTIVE_FROM,
    RECORD_SOURCE,
    COLLISION_KEY,
    COMPANY_ID,
    COMPANY_HK

    FROM hashed_columns
)

SELECT * FROM columns_to_select
;

SELECT DISTINCT LABORDTL_COMPANY
                    , EXTRACT_DATE
                 FROM TIM_WILSON.BRONZE.src_resgrpeff
;

INSERT INTO DATAVAULT_SHARED.ECORE_SOURCE_DATA.RESGRPEFF
(LABORDTL_COMPANY, EXTRACT_DATE)
VALUES
('XYZ', TO_TIMESTAMP('2025-04-30 11:17:01.234567'))
;

DELETE FROM DATAVAULT_SHARED.ECORE_SOURCE_DATA.RESGRPEFF
WHERE LABORDTL_COMPANY = 'XYZ'
;



