DROP SCHEMA SANDBOX.BMC_ZUORA_PRIMED_STAGING
;

create or replace schema BMC_ZUORA_PRIMED_STAGING;

create or replace view PRIMED_STG_ZUORA_PRODUCT(
	ALLOWFEATURECHANGES,
	UPDATEDBYID,
	UPDATEDDATE,
	CREATEDDATE,
	DESCRIPTION,
	EFFECTIVEENDDATE,
	CATEGORY,
	CREATEDBYID,
	DELETED,
	EFFECTIVESTARTDATE,
	ID,
	NAME,
	SKU,
	LOAD_DATETIME,
	START_DATE,
	END_DATE,
	EFFECTIVE_FROM,
	RECORD_SOURCE,
	COLLISION_KEY,
	PRODUCT_HK,
	PRODUCT_HASHDIFF
) as (


-- Generated by dbtvault.



WITH source_data AS (

    SELECT

    "ALLOWFEATURECHANGES",
    "UPDATEDBYID",
    "UPDATEDDATE",
    "CREATEDDATE",
    "DESCRIPTION",
    "EFFECTIVEENDDATE",
    "CATEGORY",
    "CREATEDBYID",
    "DELETED",
    "EFFECTIVESTARTDATE",
    "ID",
    "NAME",
    "SKU"

    FROM DBTVAULT_DEV.BMC_ZUORA_STAGING.stg_zuora_product
),

derived_columns AS (

    SELECT

    "ALLOWFEATURECHANGES",
    "UPDATEDBYID",
    "UPDATEDDATE",
    "CREATEDDATE",
    "DESCRIPTION",
    "EFFECTIVEENDDATE",
    "CATEGORY",
    "CREATEDBYID",
    "DELETED",
    "EFFECTIVESTARTDATE",
    "ID",
    "NAME",
    "SKU",
    TO_TIMESTAMP('2022-11-30 16:31:57.709371') AS "LOAD_DATETIME",
    TO_TIMESTAMP('1900-01-01 00:00:00.000000') AS "START_DATE",
    TO_TIMESTAMP('9999-12-31 23:59:59.999999') AS "END_DATE",
    TO_TIMESTAMP('1900-01-01 00:00:00.000000') AS "EFFECTIVE_FROM",
    'ZUORA.PRODUCT' AS "RECORD_SOURCE",
    'ZUORA' AS "COLLISION_KEY"

    FROM source_data
),

hashed_columns AS (

    SELECT

    "ALLOWFEATURECHANGES",
    "UPDATEDBYID",
    "UPDATEDDATE",
    "CREATEDDATE",
    "DESCRIPTION",
    "EFFECTIVEENDDATE",
    "CATEGORY",
    "CREATEDBYID",
    "DELETED",
    "EFFECTIVESTARTDATE",
    "ID",
    "NAME",
    "SKU",
    "LOAD_DATETIME",
    "START_DATE",
    "END_DATE",
    "EFFECTIVE_FROM",
    "RECORD_SOURCE",
    "COLLISION_KEY",

    CAST(MD5_BINARY(NULLIF(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST("COLLISION_KEY" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("ID" AS VARCHAR))), ''), '^^')
    ), '^^||^^')) AS BINARY(16)) AS "PRODUCT_HK",
    CAST(MD5_BINARY(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST("ALLOWFEATURECHANGES" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("CATEGORY" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("CREATEDBYID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("CREATEDDATE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("DELETED" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("DESCRIPTION" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("EFFECTIVEENDDATE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("EFFECTIVESTARTDATE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("ID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("NAME" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("SKU" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("UPDATEDBYID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("UPDATEDDATE" AS VARCHAR))), ''), '^^')
    )) AS BINARY(16)) AS "PRODUCT_HASHDIFF"

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    "ALLOWFEATURECHANGES",
    "UPDATEDBYID",
    "UPDATEDDATE",
    "CREATEDDATE",
    "DESCRIPTION",
    "EFFECTIVEENDDATE",
    "CATEGORY",
    "CREATEDBYID",
    "DELETED",
    "EFFECTIVESTARTDATE",
    "ID",
    "NAME",
    "SKU",
    "LOAD_DATETIME",
    "START_DATE",
    "END_DATE",
    "EFFECTIVE_FROM",
    "RECORD_SOURCE",
    "COLLISION_KEY",
    "PRODUCT_HK",
    "PRODUCT_HASHDIFF"

    FROM hashed_columns
)

SELECT * FROM columns_to_select
  );
create or replace view PRIMED_STG_ZUORA_PRODUCTRATEPLAN(
	CREATEDBYID,
	EFFECTIVEENDDATE,
	ID,
	UPDATEDBYID,
	PRODUCTID,
	UPDATEDDATE,
	DELETED,
	DESCRIPTION,
	EFFECTIVESTARTDATE,
	CREATEDDATE,
	NAME,
	LOAD_DATETIME,
	START_DATE,
	END_DATE,
	EFFECTIVE_FROM,
	RECORD_SOURCE,
	COLLISION_KEY,
	PRODUCTRATEPLAN_HK,
	PRODUCT_HK,
	PRODUCT_HAS_PRODUCT_RATE_PLAN_HK,
	PRODUCTRATEPLAN_HASHDIFF
) as (


-- Generated by dbtvault.



WITH source_data AS (

    SELECT

    "CREATEDBYID",
    "EFFECTIVEENDDATE",
    "ID",
    "UPDATEDBYID",
    "PRODUCTID",
    "UPDATEDDATE",
    "DELETED",
    "DESCRIPTION",
    "EFFECTIVESTARTDATE",
    "CREATEDDATE",
    "NAME"

    FROM DBTVAULT_DEV.BMC_ZUORA_STAGING.stg_zuora_productrateplan
),

derived_columns AS (

    SELECT

    "CREATEDBYID",
    "EFFECTIVEENDDATE",
    "ID",
    "UPDATEDBYID",
    "PRODUCTID",
    "UPDATEDDATE",
    "DELETED",
    "DESCRIPTION",
    "EFFECTIVESTARTDATE",
    "CREATEDDATE",
    "NAME",
    TO_TIMESTAMP('2022-11-30 16:31:57.709371') AS "LOAD_DATETIME",
    TO_TIMESTAMP('1900-01-01 00:00:00.000000') AS "START_DATE",
    TO_TIMESTAMP('9999-12-31 23:59:59.999999') AS "END_DATE",
    TO_TIMESTAMP('1900-01-01 00:00:00.000000') AS "EFFECTIVE_FROM",
    'ZUORA.PRODUCTRATEPLAN' AS "RECORD_SOURCE",
    'ZUORA' AS "COLLISION_KEY"

    FROM source_data
),

hashed_columns AS (

    SELECT

    "CREATEDBYID",
    "EFFECTIVEENDDATE",
    "ID",
    "UPDATEDBYID",
    "PRODUCTID",
    "UPDATEDDATE",
    "DELETED",
    "DESCRIPTION",
    "EFFECTIVESTARTDATE",
    "CREATEDDATE",
    "NAME",
    "LOAD_DATETIME",
    "START_DATE",
    "END_DATE",
    "EFFECTIVE_FROM",
    "RECORD_SOURCE",
    "COLLISION_KEY",

    CAST(MD5_BINARY(NULLIF(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST("COLLISION_KEY" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("ID" AS VARCHAR))), ''), '^^')
    ), '^^||^^')) AS BINARY(16)) AS "PRODUCTRATEPLAN_HK",
    CAST(MD5_BINARY(NULLIF(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST("COLLISION_KEY" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("PRODUCTID" AS VARCHAR))), ''), '^^')
    ), '^^||^^')) AS BINARY(16)) AS "PRODUCT_HK",
    CAST(MD5_BINARY(NULLIF(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST("COLLISION_KEY" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("ID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("COLLISION_KEY" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("PRODUCTID" AS VARCHAR))), ''), '^^')
    ), '^^||^^||^^||^^')) AS BINARY(16)) AS "PRODUCT_HAS_PRODUCT_RATE_PLAN_HK",
    CAST(MD5_BINARY(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST("CREATEDBYID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("CREATEDDATE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("DELETED" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("DESCRIPTION" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("EFFECTIVEENDDATE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("EFFECTIVESTARTDATE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("ID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("NAME" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("PRODUCTID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("UPDATEDBYID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("UPDATEDDATE" AS VARCHAR))), ''), '^^')
    )) AS BINARY(16)) AS "PRODUCTRATEPLAN_HASHDIFF"

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    "CREATEDBYID",
    "EFFECTIVEENDDATE",
    "ID",
    "UPDATEDBYID",
    "PRODUCTID",
    "UPDATEDDATE",
    "DELETED",
    "DESCRIPTION",
    "EFFECTIVESTARTDATE",
    "CREATEDDATE",
    "NAME",
    "LOAD_DATETIME",
    "START_DATE",
    "END_DATE",
    "EFFECTIVE_FROM",
    "RECORD_SOURCE",
    "COLLISION_KEY",
    "PRODUCTRATEPLAN_HK",
    "PRODUCT_HK",
    "PRODUCT_HAS_PRODUCT_RATE_PLAN_HK",
    "PRODUCTRATEPLAN_HASHDIFF"

    FROM hashed_columns
)

SELECT * FROM columns_to_select
  );
create or replace view PRIMED_STG_ZUORA_PRODUCTRATEPLANCHARGE(
	DEFAULTQUANTITY,
	DELETED,
	MAXQUANTITY,
	OVERAGECALCULATIONOPTION,
	REVRECCODE,
	TAXMODE,
	LEGACYREVENUEREPORTING,
	UPTOPERIODSTYPE,
	ADJUSTMENTREVENUEACCOUNTINGCODEID,
	BILLINGPERIODALIGNMENT,
	BILLINGTIMING,
	PRODUCTRATEPLANID,
	CREATEDBYID,
	RECOGNIZEDREVENUEACCOUNTINGCODEID,
	TAXCODE,
	DISCOUNTCLASSID,
	UPTOPERIODS,
	CONTRACTLIABILITYACCOUNTINGCODEID,
	CONTRACTRECOGNIZEDREVENUEACCOUNTINGCODEID,
	TRIGGEREVENT,
	CONTRACTASSETACCOUNTINGCODEID,
	SMOOTHINGMODEL,
	ACCOUNTINGCODE,
	ADJUSTMENTLIABILITYACCOUNTINGCODEID,
	APPLYDISCOUNTTO,
	CHARGEMODEL,
	ID,
	INCLUDEDUNITS,
	OVERAGEUNUSEDUNITSCREDITOPTION,
	NUMBEROFPERIOD,
	RATINGGROUP,
	UOM,
	REVENUERECOGNITIONRULENAME,
	DEFERREDREVENUEACCOUNT,
	DEFERREDREVENUEACCOUNTINGCODEID,
	DISCOUNTLEVEL,
	PRICECHANGEOPTION,
	USEDISCOUNTSPECIFICACCOUNTINGCODE,
	RECOGNIZEDREVENUEACCOUNT,
	SPECIFICBILLINGPERIOD,
	USETENANTDEFAULTFORPRICECHANGE,
	BILLCYCLEDAY,
	CHARGETYPE,
	ENDDATECONDITION,
	LISTPRICEBASE,
	UNBILLEDRECEIVABLESACCOUNTINGCODEID,
	NAME,
	REVRECTRIGGERCONDITION,
	DESCRIPTION,
	UPDATEDBYID,
	ACCOUNTRECEIVABLEACCOUNTINGCODEID,
	BILLCYCLETYPE,
	CREATEDDATE,
	UPDATEDDATE,
	BILLINGPERIOD,
	MINQUANTITY,
	PRICEINCREASEPERCENTAGE,
	USAGERECORDRATINGOPTION,
	TAXABLE,
	WEEKLYBILLCYCLEDAY,
	LOAD_DATETIME,
	START_DATE,
	END_DATE,
	EFFECTIVE_FROM,
	RECORD_SOURCE,
	COLLISION_KEY,
	PRODUCTRATEPLANCHARGE_HK,
	PRODUCTRATEPLAN_HK,
	PRODUCTRATEPLANCHARGE_HASHDIFF
) as (


-- Generated by dbtvault.



WITH source_data AS (

    SELECT

    "DEFAULTQUANTITY",
    "DELETED",
    "MAXQUANTITY",
    "OVERAGECALCULATIONOPTION",
    "REVRECCODE",
    "TAXMODE",
    "LEGACYREVENUEREPORTING",
    "UPTOPERIODSTYPE",
    "ADJUSTMENTREVENUEACCOUNTINGCODEID",
    "BILLINGPERIODALIGNMENT",
    "BILLINGTIMING",
    "PRODUCTRATEPLANID",
    "CREATEDBYID",
    "RECOGNIZEDREVENUEACCOUNTINGCODEID",
    "TAXCODE",
    "DISCOUNTCLASSID",
    "UPTOPERIODS",
    "CONTRACTLIABILITYACCOUNTINGCODEID",
    "CONTRACTRECOGNIZEDREVENUEACCOUNTINGCODEID",
    "TRIGGEREVENT",
    "CONTRACTASSETACCOUNTINGCODEID",
    "SMOOTHINGMODEL",
    "ACCOUNTINGCODE",
    "ADJUSTMENTLIABILITYACCOUNTINGCODEID",
    "APPLYDISCOUNTTO",
    "CHARGEMODEL",
    "ID",
    "INCLUDEDUNITS",
    "OVERAGEUNUSEDUNITSCREDITOPTION",
    "NUMBEROFPERIOD",
    "RATINGGROUP",
    "UOM",
    "REVENUERECOGNITIONRULENAME",
    "DEFERREDREVENUEACCOUNT",
    "DEFERREDREVENUEACCOUNTINGCODEID",
    "DISCOUNTLEVEL",
    "PRICECHANGEOPTION",
    "USEDISCOUNTSPECIFICACCOUNTINGCODE",
    "RECOGNIZEDREVENUEACCOUNT",
    "SPECIFICBILLINGPERIOD",
    "USETENANTDEFAULTFORPRICECHANGE",
    "BILLCYCLEDAY",
    "CHARGETYPE",
    "ENDDATECONDITION",
    "LISTPRICEBASE",
    "UNBILLEDRECEIVABLESACCOUNTINGCODEID",
    "NAME",
    "REVRECTRIGGERCONDITION",
    "DESCRIPTION",
    "UPDATEDBYID",
    "ACCOUNTRECEIVABLEACCOUNTINGCODEID",
    "BILLCYCLETYPE",
    "CREATEDDATE",
    "UPDATEDDATE",
    "BILLINGPERIOD",
    "MINQUANTITY",
    "PRICEINCREASEPERCENTAGE",
    "USAGERECORDRATINGOPTION",
    "TAXABLE",
    "WEEKLYBILLCYCLEDAY"

    FROM DBTVAULT_DEV.BMC_ZUORA_STAGING.stg_zuora_productrateplancharge
),

derived_columns AS (

    SELECT

    "DEFAULTQUANTITY",
    "DELETED",
    "MAXQUANTITY",
    "OVERAGECALCULATIONOPTION",
    "REVRECCODE",
    "TAXMODE",
    "LEGACYREVENUEREPORTING",
    "UPTOPERIODSTYPE",
    "ADJUSTMENTREVENUEACCOUNTINGCODEID",
    "BILLINGPERIODALIGNMENT",
    "BILLINGTIMING",
    "PRODUCTRATEPLANID",
    "CREATEDBYID",
    "RECOGNIZEDREVENUEACCOUNTINGCODEID",
    "TAXCODE",
    "DISCOUNTCLASSID",
    "UPTOPERIODS",
    "CONTRACTLIABILITYACCOUNTINGCODEID",
    "CONTRACTRECOGNIZEDREVENUEACCOUNTINGCODEID",
    "TRIGGEREVENT",
    "CONTRACTASSETACCOUNTINGCODEID",
    "SMOOTHINGMODEL",
    "ACCOUNTINGCODE",
    "ADJUSTMENTLIABILITYACCOUNTINGCODEID",
    "APPLYDISCOUNTTO",
    "CHARGEMODEL",
    "ID",
    "INCLUDEDUNITS",
    "OVERAGEUNUSEDUNITSCREDITOPTION",
    "NUMBEROFPERIOD",
    "RATINGGROUP",
    "UOM",
    "REVENUERECOGNITIONRULENAME",
    "DEFERREDREVENUEACCOUNT",
    "DEFERREDREVENUEACCOUNTINGCODEID",
    "DISCOUNTLEVEL",
    "PRICECHANGEOPTION",
    "USEDISCOUNTSPECIFICACCOUNTINGCODE",
    "RECOGNIZEDREVENUEACCOUNT",
    "SPECIFICBILLINGPERIOD",
    "USETENANTDEFAULTFORPRICECHANGE",
    "BILLCYCLEDAY",
    "CHARGETYPE",
    "ENDDATECONDITION",
    "LISTPRICEBASE",
    "UNBILLEDRECEIVABLESACCOUNTINGCODEID",
    "NAME",
    "REVRECTRIGGERCONDITION",
    "DESCRIPTION",
    "UPDATEDBYID",
    "ACCOUNTRECEIVABLEACCOUNTINGCODEID",
    "BILLCYCLETYPE",
    "CREATEDDATE",
    "UPDATEDDATE",
    "BILLINGPERIOD",
    "MINQUANTITY",
    "PRICEINCREASEPERCENTAGE",
    "USAGERECORDRATINGOPTION",
    "TAXABLE",
    "WEEKLYBILLCYCLEDAY",
    TO_TIMESTAMP('2022-11-30 16:31:57.709371') AS "LOAD_DATETIME",
    TO_TIMESTAMP('1900-01-01 00:00:00.000000') AS "START_DATE",
    TO_TIMESTAMP('9999-12-31 23:59:59.999999') AS "END_DATE",
    TO_TIMESTAMP('1900-01-01 00:00:00.000000') AS "EFFECTIVE_FROM",
    'ZUORA.PRODUCTRATEPLANCHARGE' AS "RECORD_SOURCE",
    'ZUORA' AS "COLLISION_KEY"

    FROM source_data
),

hashed_columns AS (

    SELECT

    "DEFAULTQUANTITY",
    "DELETED",
    "MAXQUANTITY",
    "OVERAGECALCULATIONOPTION",
    "REVRECCODE",
    "TAXMODE",
    "LEGACYREVENUEREPORTING",
    "UPTOPERIODSTYPE",
    "ADJUSTMENTREVENUEACCOUNTINGCODEID",
    "BILLINGPERIODALIGNMENT",
    "BILLINGTIMING",
    "PRODUCTRATEPLANID",
    "CREATEDBYID",
    "RECOGNIZEDREVENUEACCOUNTINGCODEID",
    "TAXCODE",
    "DISCOUNTCLASSID",
    "UPTOPERIODS",
    "CONTRACTLIABILITYACCOUNTINGCODEID",
    "CONTRACTRECOGNIZEDREVENUEACCOUNTINGCODEID",
    "TRIGGEREVENT",
    "CONTRACTASSETACCOUNTINGCODEID",
    "SMOOTHINGMODEL",
    "ACCOUNTINGCODE",
    "ADJUSTMENTLIABILITYACCOUNTINGCODEID",
    "APPLYDISCOUNTTO",
    "CHARGEMODEL",
    "ID",
    "INCLUDEDUNITS",
    "OVERAGEUNUSEDUNITSCREDITOPTION",
    "NUMBEROFPERIOD",
    "RATINGGROUP",
    "UOM",
    "REVENUERECOGNITIONRULENAME",
    "DEFERREDREVENUEACCOUNT",
    "DEFERREDREVENUEACCOUNTINGCODEID",
    "DISCOUNTLEVEL",
    "PRICECHANGEOPTION",
    "USEDISCOUNTSPECIFICACCOUNTINGCODE",
    "RECOGNIZEDREVENUEACCOUNT",
    "SPECIFICBILLINGPERIOD",
    "USETENANTDEFAULTFORPRICECHANGE",
    "BILLCYCLEDAY",
    "CHARGETYPE",
    "ENDDATECONDITION",
    "LISTPRICEBASE",
    "UNBILLEDRECEIVABLESACCOUNTINGCODEID",
    "NAME",
    "REVRECTRIGGERCONDITION",
    "DESCRIPTION",
    "UPDATEDBYID",
    "ACCOUNTRECEIVABLEACCOUNTINGCODEID",
    "BILLCYCLETYPE",
    "CREATEDDATE",
    "UPDATEDDATE",
    "BILLINGPERIOD",
    "MINQUANTITY",
    "PRICEINCREASEPERCENTAGE",
    "USAGERECORDRATINGOPTION",
    "TAXABLE",
    "WEEKLYBILLCYCLEDAY",
    "LOAD_DATETIME",
    "START_DATE",
    "END_DATE",
    "EFFECTIVE_FROM",
    "RECORD_SOURCE",
    "COLLISION_KEY",

    CAST(MD5_BINARY(NULLIF(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST("COLLISION_KEY" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("ID" AS VARCHAR))), ''), '^^')
    ), '^^||^^')) AS BINARY(16)) AS "PRODUCTRATEPLANCHARGE_HK",
    CAST(MD5_BINARY(NULLIF(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST("COLLISION_KEY" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("PRODUCTRATEPLANID" AS VARCHAR))), ''), '^^')
    ), '^^||^^')) AS BINARY(16)) AS "PRODUCTRATEPLAN_HK",
    CAST(MD5_BINARY(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST("ACCOUNTINGCODE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("ACCOUNTRECEIVABLEACCOUNTINGCODEID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("ADJUSTMENTLIABILITYACCOUNTINGCODEID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("ADJUSTMENTREVENUEACCOUNTINGCODEID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("APPLYDISCOUNTTO" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("BILLCYCLEDAY" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("BILLCYCLETYPE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("BILLINGPERIOD" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("BILLINGPERIODALIGNMENT" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("BILLINGTIMING" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("CHARGEMODEL" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("CHARGETYPE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("CONTRACTASSETACCOUNTINGCODEID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("CONTRACTLIABILITYACCOUNTINGCODEID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("CONTRACTRECOGNIZEDREVENUEACCOUNTINGCODEID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("CREATEDBYID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("CREATEDDATE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("DEFAULTQUANTITY" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("DEFERREDREVENUEACCOUNT" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("DEFERREDREVENUEACCOUNTINGCODEID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("DELETED" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("DESCRIPTION" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("DISCOUNTCLASSID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("DISCOUNTLEVEL" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("ENDDATECONDITION" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("ID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("INCLUDEDUNITS" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("LEGACYREVENUEREPORTING" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("LISTPRICEBASE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("MAXQUANTITY" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("MINQUANTITY" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("NAME" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("NUMBEROFPERIOD" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("OVERAGECALCULATIONOPTION" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("OVERAGEUNUSEDUNITSCREDITOPTION" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("PRICECHANGEOPTION" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("PRICEINCREASEPERCENTAGE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("PRODUCTRATEPLANID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("RATINGGROUP" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("RECOGNIZEDREVENUEACCOUNT" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("RECOGNIZEDREVENUEACCOUNTINGCODEID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("REVENUERECOGNITIONRULENAME" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("REVRECCODE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("REVRECTRIGGERCONDITION" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("SMOOTHINGMODEL" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("SPECIFICBILLINGPERIOD" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("TAXABLE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("TAXCODE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("TAXMODE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("TRIGGEREVENT" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("UNBILLEDRECEIVABLESACCOUNTINGCODEID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("UOM" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("UPDATEDBYID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("UPDATEDDATE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("UPTOPERIODS" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("UPTOPERIODSTYPE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("USAGERECORDRATINGOPTION" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("USEDISCOUNTSPECIFICACCOUNTINGCODE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("USETENANTDEFAULTFORPRICECHANGE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("WEEKLYBILLCYCLEDAY" AS VARCHAR))), ''), '^^')
    )) AS BINARY(16)) AS "PRODUCTRATEPLANCHARGE_HASHDIFF"

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    "DEFAULTQUANTITY",
    "DELETED",
    "MAXQUANTITY",
    "OVERAGECALCULATIONOPTION",
    "REVRECCODE",
    "TAXMODE",
    "LEGACYREVENUEREPORTING",
    "UPTOPERIODSTYPE",
    "ADJUSTMENTREVENUEACCOUNTINGCODEID",
    "BILLINGPERIODALIGNMENT",
    "BILLINGTIMING",
    "PRODUCTRATEPLANID",
    "CREATEDBYID",
    "RECOGNIZEDREVENUEACCOUNTINGCODEID",
    "TAXCODE",
    "DISCOUNTCLASSID",
    "UPTOPERIODS",
    "CONTRACTLIABILITYACCOUNTINGCODEID",
    "CONTRACTRECOGNIZEDREVENUEACCOUNTINGCODEID",
    "TRIGGEREVENT",
    "CONTRACTASSETACCOUNTINGCODEID",
    "SMOOTHINGMODEL",
    "ACCOUNTINGCODE",
    "ADJUSTMENTLIABILITYACCOUNTINGCODEID",
    "APPLYDISCOUNTTO",
    "CHARGEMODEL",
    "ID",
    "INCLUDEDUNITS",
    "OVERAGEUNUSEDUNITSCREDITOPTION",
    "NUMBEROFPERIOD",
    "RATINGGROUP",
    "UOM",
    "REVENUERECOGNITIONRULENAME",
    "DEFERREDREVENUEACCOUNT",
    "DEFERREDREVENUEACCOUNTINGCODEID",
    "DISCOUNTLEVEL",
    "PRICECHANGEOPTION",
    "USEDISCOUNTSPECIFICACCOUNTINGCODE",
    "RECOGNIZEDREVENUEACCOUNT",
    "SPECIFICBILLINGPERIOD",
    "USETENANTDEFAULTFORPRICECHANGE",
    "BILLCYCLEDAY",
    "CHARGETYPE",
    "ENDDATECONDITION",
    "LISTPRICEBASE",
    "UNBILLEDRECEIVABLESACCOUNTINGCODEID",
    "NAME",
    "REVRECTRIGGERCONDITION",
    "DESCRIPTION",
    "UPDATEDBYID",
    "ACCOUNTRECEIVABLEACCOUNTINGCODEID",
    "BILLCYCLETYPE",
    "CREATEDDATE",
    "UPDATEDDATE",
    "BILLINGPERIOD",
    "MINQUANTITY",
    "PRICEINCREASEPERCENTAGE",
    "USAGERECORDRATINGOPTION",
    "TAXABLE",
    "WEEKLYBILLCYCLEDAY",
    "LOAD_DATETIME",
    "START_DATE",
    "END_DATE",
    "EFFECTIVE_FROM",
    "RECORD_SOURCE",
    "COLLISION_KEY",
    "PRODUCTRATEPLANCHARGE_HK",
    "PRODUCTRATEPLAN_HK",
    "PRODUCTRATEPLANCHARGE_HASHDIFF"

    FROM hashed_columns
)

SELECT * FROM columns_to_select
  );
create or replace view PRIMED_STG_ZUORA_PRODUCTRATEPLANCHARGETIER(
	ID,
	OVERAGEPRICE,
	PRICE,
	PRICEFORMAT,
	PRODUCTRATEPLANCHARGEID,
	ACTIVE,
	INCLUDEDUNITS,
	TIER,
	CREATEDDATE,
	UPDATEDBYID,
	CREATEDBYID,
	CURRENCY,
	DISCOUNTPERCENTAGE,
	UPDATEDDATE,
	STARTINGUNIT,
	DELETED,
	DISCOUNTAMOUNT,
	ENDINGUNIT,
	LOAD_DATETIME,
	START_DATE,
	END_DATE,
	EFFECTIVE_FROM,
	RECORD_SOURCE,
	COLLISION_KEY,
	PRODUCTRATEPLANCHARGETIER_HK,
	PRODUCTRATEPLANCHARGETIER_HASHDIFF
) as (


-- Generated by dbtvault.



WITH source_data AS (

    SELECT

    "ID",
    "OVERAGEPRICE",
    "PRICE",
    "PRICEFORMAT",
    "PRODUCTRATEPLANCHARGEID",
    "ACTIVE",
    "INCLUDEDUNITS",
    "TIER",
    "CREATEDDATE",
    "UPDATEDBYID",
    "CREATEDBYID",
    "CURRENCY",
    "DISCOUNTPERCENTAGE",
    "UPDATEDDATE",
    "STARTINGUNIT",
    "DELETED",
    "DISCOUNTAMOUNT",
    "ENDINGUNIT"

    FROM DBTVAULT_DEV.BMC_ZUORA_STAGING.stg_zuora_productrateplanchargetier
),

derived_columns AS (

    SELECT

    "ID",
    "OVERAGEPRICE",
    "PRICE",
    "PRICEFORMAT",
    "PRODUCTRATEPLANCHARGEID",
    "ACTIVE",
    "INCLUDEDUNITS",
    "TIER",
    "CREATEDDATE",
    "UPDATEDBYID",
    "CREATEDBYID",
    "CURRENCY",
    "DISCOUNTPERCENTAGE",
    "UPDATEDDATE",
    "STARTINGUNIT",
    "DELETED",
    "DISCOUNTAMOUNT",
    "ENDINGUNIT",
    TO_TIMESTAMP('2022-11-30 16:31:57.709371') AS "LOAD_DATETIME",
    TO_TIMESTAMP('1900-01-01 00:00:00.000000') AS "START_DATE",
    TO_TIMESTAMP('9999-12-31 23:59:59.999999') AS "END_DATE",
    TO_TIMESTAMP('1900-01-01 00:00:00.000000') AS "EFFECTIVE_FROM",
    'ZUORA.PRODUCTRATEPLANCHARGETIER' AS "RECORD_SOURCE",
    'ZUORA' AS "COLLISION_KEY"

    FROM source_data
),

hashed_columns AS (

    SELECT

    "ID",
    "OVERAGEPRICE",
    "PRICE",
    "PRICEFORMAT",
    "PRODUCTRATEPLANCHARGEID",
    "ACTIVE",
    "INCLUDEDUNITS",
    "TIER",
    "CREATEDDATE",
    "UPDATEDBYID",
    "CREATEDBYID",
    "CURRENCY",
    "DISCOUNTPERCENTAGE",
    "UPDATEDDATE",
    "STARTINGUNIT",
    "DELETED",
    "DISCOUNTAMOUNT",
    "ENDINGUNIT",
    "LOAD_DATETIME",
    "START_DATE",
    "END_DATE",
    "EFFECTIVE_FROM",
    "RECORD_SOURCE",
    "COLLISION_KEY",

    CAST(MD5_BINARY(NULLIF(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST("COLLISION_KEY" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("ID" AS VARCHAR))), ''), '^^')
    ), '^^||^^')) AS BINARY(16)) AS "PRODUCTRATEPLANCHARGETIER_HK",
    CAST(MD5_BINARY(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST("ACTIVE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("CREATEDBYID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("CREATEDDATE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("CURRENCY" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("DELETED" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("DISCOUNTAMOUNT" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("DISCOUNTPERCENTAGE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("ENDINGUNIT" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("ID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("INCLUDEDUNITS" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("OVERAGEPRICE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("PRICE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("PRICEFORMAT" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("PRODUCTRATEPLANCHARGEID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("STARTINGUNIT" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("TIER" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("UPDATEDBYID" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("UPDATEDDATE" AS VARCHAR))), ''), '^^')
    )) AS BINARY(16)) AS "PRODUCTRATEPLANCHARGETIER_HASHDIFF"

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    "ID",
    "OVERAGEPRICE",
    "PRICE",
    "PRICEFORMAT",
    "PRODUCTRATEPLANCHARGEID",
    "ACTIVE",
    "INCLUDEDUNITS",
    "TIER",
    "CREATEDDATE",
    "UPDATEDBYID",
    "CREATEDBYID",
    "CURRENCY",
    "DISCOUNTPERCENTAGE",
    "UPDATEDDATE",
    "STARTINGUNIT",
    "DELETED",
    "DISCOUNTAMOUNT",
    "ENDINGUNIT",
    "LOAD_DATETIME",
    "START_DATE",
    "END_DATE",
    "EFFECTIVE_FROM",
    "RECORD_SOURCE",
    "COLLISION_KEY",
    "PRODUCTRATEPLANCHARGETIER_HK",
    "PRODUCTRATEPLANCHARGETIER_HASHDIFF"

    FROM hashed_columns
)

SELECT * FROM columns_to_select
  );