USE ROLE TIMWILSONDV;

USE DATABASE VAULT_FIVETRAN;

-- Generate a SELECT script to determine record counts
-- for tables being replicated by Fivetran

SELECT LISTAGG(SELECTION, ' UNION ALL ') || ';'
FROM (
    SELECT 
    CASE WHEN TABLE_SCHEMA LIKE '%NETSUITE' THEN
        'SELECT \'' || OBJECT_NAME || '\' AS OBJECT_NAME, COUNT(*) AS RECORD_COUNT, (SELECT COUNT(*) FROM ' || OBJECT_NAME || ' WHERE _FIVETRAN_DELETED = TRUE) AS DELETED_COUNT FROM ' || OBJECT_NAME
    ELSE
        'SELECT \'' || OBJECT_NAME || '\' AS OBJECT_NAME, COUNT(*) AS RECORD_COUNT, -1 AS DELETED_COUNT FROM ' || OBJECT_NAME
    END AS SELECTION
    FROM (
        SELECT TABLE_SCHEMA, TABLE_CATALOG ||'.'|| TABLE_SCHEMA ||'."'|| TABLE_NAME ||'"' AS OBJECT_NAME
        FROM  VAULT_FIVETRAN.INFORMATION_SCHEMA.TABLES
        WHERE TABLE_SCHEMA NOT IN ('INFORMATION_SCHEMA', 'PUBLIC', 'TESTSCHEMA', 'FIVETRAN_RELIEF_UNSUBTLE_STAGING')
        AND TABLE_NAME NOT LIKE 'FIVETRAN%'
        UNION ALL
        SELECT TABLE_SCHEMA, TABLE_CATALOG ||'.'|| TABLE_SCHEMA ||'."'|| TABLE_NAME ||'"' AS OBJECT_NAME
        FROM  VAULT_FIVETRAN.INFORMATION_SCHEMA.VIEWS
        WHERE TABLE_SCHEMA NOT IN ('INFORMATION_SCHEMA', 'PUBLIC', 'TESTSCHEMA', 'FIVETRAN_RELIEF_UNSUBTLE_STAGING')
        AND TABLE_NAME NOT LIKE 'FIVETRAN%'
    )
)
;
